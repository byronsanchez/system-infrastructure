#!/bin/sh
#
# Copies playlist files to a specified directory

source /usr/local/lib/nitelite/helpers/common.lib.sh;

MUSIC_DIRECTORY="/mnt/luna/Music"
PLAYLIST_DIRECTORY="$MUSIC_DIRECTORY/Playlists"

update_type="$1"
WORKDIR="/tmp/nitelite"

# Initialize our own variables:
destination=""
playlist=""
quiet=0

############################
# Argument Parsing Functions

function show_help ()
{
cat <<-EOM

$0 [OPTION]

options:

    -p --playlist=NAME           playlist name
    -d --destination=NAME        destination path
    -q --quiet                   do not log messages to STDOUT
    -h --help                    display this message

EOM
    exit 1
}

function get_options () {
    argv=()
    while [ $# -gt 0 ]
    do
        opt=$1
        shift
        case ${opt} in
            -p|--playlist)
                playlist=$1
                shift
                ;;
            --playlist=*)
                playlist=$(echo ${opt} | cut -d'=' -f 2);
                ;;
            -d|--destination)
                destination=$1
                shift
                ;;
            --destination=*)
                destination=$(echo ${opt} | cut -d'=' -f 2);
                ;;
            -q|--quiet)
                quiet=1
                ;;
            -h|--help)
                show_help
                ;;
            *)
                if [ "${opt:0:1}" = "-" ]; then
                    fail "${opt}: unknown option."
                fi
                argv+=(${opt});;
        esac
    done 
}

#############
# MAIN SCRIPT

# Parse options if they were passed
get_options $*

if [ ! -n "$playlist" ];
then
  fail "Please provide a playlist name";
fi

if [ ! -n "$destination" ];
then
  fail "Please provide a destination path";
fi

PLAYLIST_FILE="$PLAYLIST_DIRECTORY/$playlist.m3u"

printf "Checking out: $PLAYLIST_FILE\n"

if [ -e "$PLAYLIST_FILE" ]; then

  printf "Playlist $PLAYLIST_FILE exists, checking out songs...\n\n"

  while read line; do
    music_file=$line
    printf "Current song: $music_file -- "

    if [ -e "$MUSIC_DIRECTORY/$music_file" ]; then

      # skip if the file already exists...
      if [ -e "${destination}/$music_file" ]; then
        info "File exists at destination. Skipping..."
        continue;
      fi

      # create all the parent directories from the source in the dest 
      # directories and then copy the file from src to dst
      message="File exists. Copying to ${destination}..."
      printf "\e[32m$message\e[0m\n"
      parentpath="$(dirname "$music_file")"
      destpath="${destination}/${parentpath}"
      mkdir -p "${destpath}"

      cp "$MUSIC_DIRECTORY/$music_file" "${destination}/$music_file"
    else
      message="File DOES NOT exist. Skipping..."
      printf "\e[31m$message\e[0m\n"
    fi

  done < "$PLAYLIST_FILE"

else

  printf "$PLAYLIST_FILE NOT a playlist file\n"

fi

