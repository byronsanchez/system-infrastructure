###########################################
#                                         #
# MANAGED BY PUPPET                       #
#                                         #
# Manual changes WILL be overwritten      #
#                                         #
###########################################

USE="agent audit bcmath device-mapper dlz gd -gpm -gtk imap ipv6 -ldap libwww maildir mhash mysql maildir png -pppd sasl sockets -sqlite3 ssl truetype ubac unicode xml -xorg udev -unconfined xattr"
CFLAGS="-march=x86-64 -O2 -pipe"
CXXFLAGS="${CFLAGS}"
CHOST="x86_64-pc-linux-gnu"
GENTOO_MIRRORS="http://binhost.internal.nitelite.io/gentoo http://mirror.mcs.anl.gov/pub/gentoo/ http://gentoo.osuosl.org/ http://mirror.lug.udel.edu/pub/gentoo/"
LDFLAGS="${LDFLAGS} -Wl,--hash-style=gnu"
# Each node has its own portage tree to track for overlays, main tree
PORTDIR="/usr/portage"
DISTDIR="/usr/portage/distfiles"
PKGDIR="/usr/portage/packages"

<% if @ipaddress == @binhost_address -%>
# k - (--usepkg) - asks emerge to try to install the prebuilt package first
# before fetching the sources and compiling it
EMERGE_DEFAULT_OPTS="-k -g"
EMERGE_EXTRA_OPTS="-k -g"
FEATURES="buildpkg webrsync-gpg userfetch"
# Set PORTDIR for backward compatibility with various tools:
#   gentoo-bashcomp - bug #478444
#   euse - bug #474574
#   euses and ufed - bug #478318
<% else -%>
PORTAGE_BINHOST="http://binhost.internal.nitelite.io/packages"
# k - (--usepkg) - asks emerge to try to install the prebuilt package first
# before fetching the sources and compiling it
# g - (--getbinpkg) - tells emerge to download the prebuilt package from the
# binhost
# binpkg-respect-use=y - ignore binaries if it's use flags don't match. This is
# important because deviations can break the infrastructure (eg. php without fpm
# is no good if the node requires fpm).
EMERGE_DEFAULT_OPTS="-k -g --binpkg-respect-use=y"
EMERGE_EXTRA_OPTS="-k -g --binpkg-respect-use=y"
FEATURES="buildpkg"
# Use nfs mounts if you get the USE flag matching scripts written
#DISTDIR="/mnt/gentoo-distfiles"
#PKGDIR="/mnt/gentoo-local-packages"
# Set PORTDIR for backward compatibility with various tools:
#   gentoo-bashcomp - bug #478444
#   euse - bug #474574
#   euses and ufed - bug #478318
<% end -%>

POLICY_TYPES="strict mcs"
PORT_LOGDIR="/var/log/portage/builds"
MAKEOPTS="-j<%= @processorcount %>"
<% if scope.lookupvar("linguas") %>
LINGUAS="<%= @linguas %>"
<% end -%>
<% if scope.lookupvar("video_cards") %>
VIDEO_CARDS="<%= @video_cards %>"
<% end -%>
<% if scope.lookupvar("input_devices") %>
INPUT_DEVICES="<%= @input_devices %>"
<% end -%>

source /var/lib/layman/make.conf

